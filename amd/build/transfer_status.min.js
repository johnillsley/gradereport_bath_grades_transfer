define(["jquery","core/templates","core/ajax","core/config","core/yui"],function(a,b,c,d,e){var f=d.wwwroot+"/grade/report/transfer/ajax.php";document.addEventListener("keydown",function(a){return 27==a.keyCode?(a.preventDefault(),!1):void 0});var g=function(b,c){var f=new M.core.dialogue({headerContent:b,bodyContent:c,draggable:!1,visible:!1,center:!0,modal:!0,width:400,closeButton:!1,hideaftersubmit:!1});return f.addButton({label:"OK",action:function(b){b.preventDefault();var c=a("#transferconfirmed"),e=c.serializeArray();window.location.href=d.wwwroot+"/grade/report/transfer/index.php?id="+e[3].value+"&mappingid="+e[4].value,f.hide()},section:e.WidgetStdMod.FOOTER}),f},h=function(a,b){var c=a.success,d=a.failed,e="Grades successfully queued : <span class='label-success label'>"+c+"</span>",f="Failed transfers : <span class='label-danger label'>"+d+"</span>",h="Total : <span class='label-info label'>"+(c+d)+"</span>",i="<div id='transfer_summary'><p>"+e+"</p><p>"+f+"</p><p>"+h+"</p><p>Total time taken: "+b+" seconds</p></div>",j=g("Summary",i);j.show()},i=function(b,c,d,e,g){var j=b[0],k=a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+j+"']"),l=k.find("td").find(".loadingDiv");l.show(),a.each(c,function(d,e){"users[]"===e.name&&c.splice(a.inArray(c[d],b),1)});var m={name:"users[]",value:j};c.push(m),a.ajax({type:"POST",dataType:"json",data:c,url:f}).done(function(f){if(console.log(f),k.attr("data-moodle-user-id")==f.userid&&("queued"==f.status?(d++,a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+f.userid+"']").find(".transfer_status").addClass("label-success").html(f.reason)):"failure"==f.status&&(e++,a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+f.userid+"']").find(".transfer_status").html(f.reason))),l.hide(),b.splice(a.inArray(j,b),1),b.length>0)i(b,c,d,e,g);else{var m=(new Date).getTime();a("body").css("cursor","default");var n={success:d,failed:e},o=m-g;o/=1e3,h(n,o)}})},j=function(b){var c=[];return a.each(b,function(b,d){var e=a(d).attr("data-moodle-user-id");a(d).attr("data-already-in-queue");c.push(e)}),c},k=function(b,c){c.preventDefault(),a(b).attr("disabled",!0);var d=a("#transferconfirmed"),e=d.serializeArray();e.push({name:"action",value:"grade_struct_exists"}),a.ajax({type:"POST",dataType:"json",data:e,url:f}).done(function(a){if(console.log(a),"grade_struct_empty"===a.status){var d="<div class='grades_transfer_summary' id='grade_struct_summary'><p>SAMIS grade structure is empty.  Unable to transfer grade information.</p> <p class=\"alert alert-warning\">If problem persists : <strong>Faculty administrators may need to run SAS1B</strong></p></div>",e=g("Pre-check",d);return e.show(),!1}console.log("Ok to queue the others"),l(b,c)})},l=function(b,c){c.preventDefault(),a(b).attr("disabled",!0);var e=a("#transferconfirmed"),f=e.serializeArray();console.log(f),a(b).next().html("Go Back").attr("href",d.wwwroot+"/grade/report/transfer/index.php?id="+f[3].value+"&mappingid="+f[4].value),a("body").css("cursor","progress");var g=a("#confirm_transfer_table tbody tr"),h=j(g),k=0,l=0,m=(new Date).getTime();i(h,f,k,l,m)};return{init:function(){a("#proceed_grade_transfer").click(function(a){k(this,a)===!0&&(console.log("GS OK, sending Grades"),l(this,a))})}}});