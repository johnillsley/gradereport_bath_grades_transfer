define(["jquery","core/templates","core/ajax","core/config","core/yui"],function(e,r,a,t,s){var n=t.wwwroot+"/grade/report/transfer/ajax.php";document.addEventListener("keydown",function(e){if(27==e.keyCode)return e.preventDefault(),!1});var o=function(r,a){var n=new M.core.dialogue({headerContent:r,bodyContent:a,draggable:!1,visible:!1,center:!0,modal:!0,width:400,closeButton:!1,hideaftersubmit:!1});return n.addButton({label:"OK",action:function(r){r.preventDefault();var a=e("#transferconfirmed").serializeArray();window.location.href=t.wwwroot+"/grade/report/transfer/index.php?id="+a[3].value+"&mappingid="+a[4].value,n.hide()},section:s.WidgetStdMod.FOOTER}),n},i=function(e,r){var a=e.success,t=e.failed;o("Summary","<div id='transfer_summary'><p>"+("Grades successfully queued : <span class='label-success label'>"+a+"</span>")+"</p><p>"+("Failed transfers : <span class='label-danger label'>"+t+"</span>")+"</p><p>"+("Total : <span class='label-info label'>"+(a+t)+"</span>")+"</p><p>Total time taken: "+r+" seconds</p></div>").show()},d=function(r,a,t,s,o){var l=r[0],u=e("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+l+"']"),c=u.find("td").find(".loadingDiv");c.show(),e.each(a,function(t,s){"users[]"===s.name&&a.splice(e.inArray(a[t],r),1)});var f={name:"users[]",value:l};a.push(f),e.ajax({type:"POST",dataType:"json",data:a,url:n}).done(function(n){if(console.log(n),u.attr("data-moodle-user-id")==n.userid&&("queued"==n.status?(t++,e("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+n.userid+"']").find(".transfer_status").addClass("label-success").html(n.reason)):"failure"==n.status&&(s++,e("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+n.userid+"']").find(".transfer_status").html(n.reason))),c.hide(),r.splice(e.inArray(l,r),1),r.length>0)d(r,a,t,s,o);else{var f=(new Date).getTime();e("body").css("cursor","default");var p=f-o;i({success:t,failed:s},p/=1e3)}})},l=function(r){var a=[];return e.each(r,function(r,t){var s=e(t).attr("data-moodle-user-id");a.push(s)}),a},u=function(r,a){a.preventDefault(),e(r).attr("disabled",!0);var s=e("#transferconfirmed").serializeArray();s.push({name:"action",value:"grade_struct_exists",sesskey:t.sesskey}),e.ajax({type:"POST",dataType:"json",data:s,url:n}).done(function(e){if(console.log(e),"grade_struct_empty"===e.status){return o("Pre-check","<div class='grades_transfer_summary' id='grade_struct_summary'><p>SAMIS grade structure is empty.  Unable to transfer grade information.</p> <p class=\"alert alert-warning\">If problem persists : <strong>Faculty administrators may need to run SAS1B</strong></p></div>").show(),!1}console.log("Ok to queue the others"),c(r,a)})},c=function(r,a){a.preventDefault(),e(r).attr("disabled",!0);var s=e("#transferconfirmed").serializeArray();console.log(s),e(r).next().html("Go Back").attr("href",t.wwwroot+"/grade/report/transfer/index.php?id="+s[3].value+"&mappingid="+s[4].value),e("body").css("cursor","progress");var n=e("#confirm_transfer_table tbody tr"),o=l(n),i=(new Date).getTime();d(o,s,0,0,i)};return{init:function(){e("#proceed_grade_transfer").click(function(e){!0===u(this,e)&&(console.log("GS OK, sending Grades"),c(this,e))})},checkGS:function(e,r){if(!0===u(e,r))return!0}}});