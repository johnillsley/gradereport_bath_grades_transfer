define(["jquery","core/templates","core/ajax","core/config","core/yui"],function(a,b,c,d,e){var f=d.wwwroot+"/grade/report/transfer/ajax.php",g=function(a,b){var c=a.success,f=a.failed,g="Grades successfully queued : <span class='label-success label'>"+c+"</span>",i="Failed transfers : <span class='label-danger label'>"+f+"</span>",j="Total : <span class='label-info label'>"+(c+f)+"</span>",k=new M.core.dialogue({headerContent:"Summary",bodyContent:"<div id='transfer_summary'><p>"+g+"</p><p>"+i+"</p><p>"+j+"</p><p>Total time taken: "+b+" seconds</p></div>",draggable:!1,visible:!1,center:!0,modal:!0,width:400,closeButton:!0,closeButtonTitle:"Close"});k.addButton({label:"OK",action:function(a){a.preventDefault();var b=h("id"),c=h("mappingid");window.location.href=d.wwwroot+"/grade/report/transfer/index.php?id="+b+"&mappingid="+c,k.hide()},section:e.WidgetStdMod.FOOTER}),k.show()},h=function(a){var b=null,c=[];return location.search.substr(1).split("&").forEach(function(d){c=d.split("="),c[0]===a&&(b=decodeURIComponent(c[1]))}),b},i=function(b,c,d,e,h){var j=b[0],k=a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+j+"']"),l=k.find("td").find(".loadingDiv");l.show(),a.each(c,function(d,e){"users[]"===e.name&&c.splice(a.inArray(c[d],b),1)});var m={name:"users[]",value:j};c.push(m),a.ajax({type:"POST",dataType:"json",data:c,url:f}).done(function(f){if(console.log(f),k.attr("data-moodle-user-id")==f.userid&&("queued"==f.status?(d++,a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+f.userid+"']").find(".transfer_status").addClass("label-success").html(f.reason)):"failure"==f.status&&(e++,a("#confirm_transfer_table tbody").find("tr[data-moodle-user-id='"+f.userid+"']").find(".transfer_status").html(f.reason))),l.hide(),b.splice(a.inArray(j,b),1),b.length>0)i(b,c,d,e,h);else{var m=(new Date).getTime();a("body").css("cursor","default");var n={success:d,failed:e},o=m-h;o/=1e3,g(n,o)}})},j=function(b){var c=[];return a.each(b,function(b,d){var e=a(d).attr("data-moodle-user-id");a(d).attr("data-already-in-queue");c.push(e)}),c},k=function(b,c){c.preventDefault(),a(b).attr("disabled",!0);var e=a("#transferconfirmed"),f=e.serializeArray();a(b).next().html("Go Back").attr("href",d.wwwroot+"/grade/report/transfer/index.php?id="+f[3].value+"&mappingid="+f[4].value),a("body").css("cursor","progress");var g=a("#confirm_transfer_table tbody tr"),h=j(g),k=0,l=0,m=(new Date).getTime();i(h,f,k,l,m)};return{init:function(){a("#proceed_grade_transfer").click(function(a){k(this,a)})}}});